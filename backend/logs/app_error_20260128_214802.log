2026-01-28 21:49:10 [ERROR] uvicorn.error: Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 186, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 93, in __call__
    |     await self.simple_response(scope, receive, send, request_headers=headers)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    |     await self.app(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.12/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/slowapi/middleware.py", line 136, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 163, in call_next
    |     raise app_exc
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/app/api/v1/endpoints/ai.py", line 547, in analyze_script_content
    |     await ai_usage_log_service.log_request(
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/app/modules/ai/service.py", line 161, in log_request
    |     await db.commit()
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    |     await greenlet_spawn(self.sync_session.commit)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 190, in greenlet_spawn
    |     result = context.switch(*args, **kwargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2028, in commit
    |     trans.commit(_to_root=True)
    |   File "<string>", line 2, in commit
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    |     self._raise_for_prerequisite_state(fn.__name__, current_state)
    |   File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    |     raise sa_exc.PendingRollbackError(
    | sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.CheckViolationError'>: new row for relation "ai_suggestions" violates check constraint "ai_suggestions_suggestion_type_check"
    | DETAIL:  Failing row contains (3ee0b461-52a2-4a4d-827b-c7af4a3001de, 4384a92c-df41-444b-b34d-6c80e7820486, 52fec1b4-6142-4b9e-ae09-252cf4ce3f9f, production, Secure location permits for the warehouse and loading dock., 0.75, medium, [], null, null, f, 2026-01-29 00:49:10.66997+00).
    | [SQL: INSERT INTO ai_suggestions (id, organization_id, project_id, suggestion_type, suggestion_text, confidence, priority, related_scenes, estimated_savings_cents, estimated_time_saved_minutes, is_applied) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::VARCHAR, $8::JSONB, $9::BIGINT, $10::INTEGER, $11::BOOLEAN) RETURNING ai_suggestions.created_at]
    | [parameters: (UUID('3ee0b461-52a2-4a4d-827b-c7af4a3001de'), UUID('4384a92c-df41-444b-b34d-6c80e7820486'), UUID('52fec1b4-6142-4b9e-ae09-252cf4ce3f9f'), 'production', 'Secure location permits for the warehouse and loading dock.', 0.75, 'medium', '[]', None, None, False)]
    | (Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 185, in __call__
    with collapse_excgroups():
         ^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.12/3.12.12/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/slowapi/middleware.py", line 136, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/app/api/v1/endpoints/ai.py", line 547, in analyze_script_content
    await ai_usage_log_service.log_request(
  File "/Users/nicolasbertoni/safetasks-v3/backend/app/modules/ai/service.py", line 161, in log_request
    await db.commit()
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1009, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 190, in greenlet_spawn
    result = context.switch(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2028, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 103, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/Users/nicolasbertoni/safetasks-v3/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 973, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.CheckViolationError'>: new row for relation "ai_suggestions" violates check constraint "ai_suggestions_suggestion_type_check"
DETAIL:  Failing row contains (3ee0b461-52a2-4a4d-827b-c7af4a3001de, 4384a92c-df41-444b-b34d-6c80e7820486, 52fec1b4-6142-4b9e-ae09-252cf4ce3f9f, production, Secure location permits for the warehouse and loading dock., 0.75, medium, [], null, null, f, 2026-01-29 00:49:10.66997+00).
[SQL: INSERT INTO ai_suggestions (id, organization_id, project_id, suggestion_type, suggestion_text, confidence, priority, related_scenes, estimated_savings_cents, estimated_time_saved_minutes, is_applied) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::VARCHAR, $5::VARCHAR, $6::FLOAT, $7::VARCHAR, $8::JSONB, $9::BIGINT, $10::INTEGER, $11::BOOLEAN) RETURNING ai_suggestions.created_at]
[parameters: (UUID('3ee0b461-52a2-4a4d-827b-c7af4a3001de'), UUID('4384a92c-df41-444b-b34d-6c80e7820486'), UUID('52fec1b4-6142-4b9e-ae09-252cf4ce3f9f'), 'production', 'Secure location permits for the warehouse and loading dock.', 0.75, 'medium', '[]', None, None, False)]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
